#ifndef INC_USART_CMD_H_
#define INC_USART_CMD_H_

#include "main.h"

#define BUF_SIZE 1024
#define HEAD 0xAA55
#define TAIL 0x7EFE
#define cmd1 0x0001 //开始、停止采样
#define cmd3 0x0003 //设置参数
#define cmd4 0x0004 //查询参数
#define cmd5 0x0005 //对时
#define cmd_number  4
#define TX_QUEUE_SIZE 32
#define MAX_PACKET_SIZE 128

extern uint8_t processing_buffer[BUF_SIZE];
extern uint8_t *wp;
extern uint8_t *rp;
extern volatile uint16_t receivercode;
extern volatile uint64_t high_counter;
extern volatile uint16_t sampling_ready;
extern volatile uint16_t txstate;
extern volatile uint16_t samplingstate;
extern uint16_t transmitlength;
extern uint8_t datatx[];
extern uint16_t FREQ;

typedef enum
{
	CMD_OK = 0,
	CODE_ERROE,
	LENGTH_ERROE,
	CMD_ERROR,
	CHECK_ERROR,
	INVALID,
	CMD_END,
}CMD_Status;

typedef struct __attribute__((packed)){
    uint8_t data[MAX_PACKET_SIZE];
    uint16_t length;
} UART_Packet;

typedef struct {
    UART_Packet packets[TX_QUEUE_SIZE];
    uint16_t head;
    uint16_t tail;
    uint8_t count;
    uint8_t isSending;
} UART_Queue;

CMD_Status CMD_Judge(void);
CMD_Status CMD_Execute(void);
void Send_Data(void);
void heartreply(void);
void datareply(void);
void maintain_processing_buffer(void);
void HAL_UART_TxCpltCallback(UART_HandleTypeDef *huart);
void CMD_HANDLE_ERROR(CMD_Status state);
void set_base_time(uint64_t timestamp);
uint64_t get_current_systick(void);
uint64_t get_current_timestamp(void);
void UART_Queue_Init(void);

#endif
